# Feature Specification: TUI English Quest v2.0

**Feature Branch**: `001-draft-english-quest-spec`  
**Created**: 2025-12-11  
**Status**: Draft  
**Input**: User description: "日本語UIのTUI英語学習RPG設計（5問×2分セッション、Gemini自動出題、5技能+装備+AI弱点分析）"

## Clarifications

### Session 2025-12-11
- Q: 会話タバーンの成功/普通/失敗判定方法は？ → A: Geminiが返答を流暢さ・関連性・タスク達成度の簡易ルーブリックで自動3段階評価し判定する

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 2分で5問の学習セッションを完走する (Priority: P1)

学習者は街メニューから任意モード（単語・文法・会話・スペリング・リスニング）を選び、開始時に取得された5問を連続で解答し、EXP/HP/コンボ/Goldが即時反映されたリザルトを受け取る。

**Why this priority**: 本体価値は短時間で完結する学習サイクルにあり、1回のセッション完走が最小の価値単位となるため。

**Independent Test**: 単独で任意モードを開始→5問解答→リザルト表示までを計測し、ステータス変化とペナルティ/報酬が仕様通りかを確認する。

**Acceptance Scenarios**:

1. **Given** 初期HP/EXPが表示された状態、**When** 単語バトルを開始して5問回答する、**Then** 指定ルール通りEXP/HP/コンボが加算・減算されリザルトに反映される。
2. **Given** 会話タバーン開始時、**When** 5ターン入力を完了する、**Then** 成功/普通/失敗に応じたEXPとGoldが付与されHPは減少しない。

---

### User Story 2 - 街で状態確認とモード選択ができる (Priority: P2)

学習者はトップ/街画面で常時表示のステータスバー（LV/EXP/HP/Combo/Streak/Gold）とAIアドバイスを確認し、j/kとEnterで任意のモード・装備・履歴・設定に移動できる。

**Why this priority**: セッション開始の導線と現在の進行状況把握が日次習慣化に直結するため。

**Independent Test**: 街画面のみでナビゲーション・ステータス表示・AIアドバイス表示が成立し、各メニューへ遷移できることを確認する。

**Acceptance Scenarios**:

1. **Given** 街画面にいる、**When** j/kでカーソル移動しEnterでモードを選択する、**Then** 対応するモード画面へ遷移しステータスバーが維持される。
2. **Given** 街画面、**When** AIアドバイス欄を確認する、**Then** 直近の弱点と推奨モードが表示される。

---

### User Story 3 - 成長確認とフィードバックで次の行動を決める (Priority: P3)

学習者はプレイ履歴・弱点分析・装備効果を確認し、次にどのモードを回すかを判断できる。履歴詳細には日付・正答数・獲得/消費リソースが記録される。

**Why this priority**: 振り返りとブースト要素が継続率と学習効率に影響するため。

**Independent Test**: セッション後に履歴とAI分析を開き、記録と推奨が更新され、装備変更が次回の報酬/軽減に反映されることを個別に確認する。

**Acceptance Scenarios**:

1. **Given** 直近のセッションが完了している、**When** 履歴を開く、**Then** モード別の結果（正答数、EXP/HP/Gold変化、日時）が一覧と詳細で確認できる。
2. **Given** 装備を変更する、**When** 次のセッションを実施する、**Then** 該当モードの報酬/ダメージが装備効果に沿って増減する。

---

### Edge Cases

- Gemini出題取得に失敗・不完全（5問未満/JSON不正）の場合はリトライ案内または安全な中断を行い、既存ステータスを変化させない。
- HPが0に到達した場合は戦闘不能演出とともにEXP -5、HPをMaxHPの50%で復活させ、街へ戻す。
- レベルアップ時は即時にMaxHP+10、HP全回復、Attack+2、Defense+1を適用し、必要EXPテーブルに従う。
- 音声リソースや入出力デバイスが利用できない場合（リスニング/オーディオ再生不能）は代替テキスト説明と再試行/スキップ選択を提示する。
- 途中離脱（Esc/q）やタイムアウト時は進行中の設問を破棄し、HP/EXP/Goldを未反映のまま街へ戻す。

### Assumptions & Dependencies

- 出題生成サービスへの接続は各モード開始時点で利用可能で、5問分を1回で取得できること。
- 端末環境が画面再描画とキー入力（j/k/Enter/Tab/q/Esc）に対応し、リスニング用の音声再生が可能であること（不可の場合はエッジケースの代替手段を用意）。
- 履歴・分析・装備情報を保持する永続ストレージがあり、日をまたいでもデータが保持されること。
- UI言語・解説設定はユーザーごとに保存され、次回起動時に復元されること。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: New Game開始時に名前とクラスを設定し、LV1/EXP0/HP100/Attack10/Defense0/Combo0/Streak0/Gold0でプロフィールを初期化する。
- **FR-002**: 全画面でステータスバーにLV、EXP進捗、HPバー、Gold、Streak、Combo（該当モード時）を常時表示する。
- **FR-003**: 街（Town）メニューで各モード（単語/文法/会話/スペリング/リスニング/装備/AI分析/履歴/ステータス/設定/終了）へj/kとEnterで遷移できる。
- **FR-004**: 各モード開始時にGeminiから5問（会話はNPC応答5ターン相当）をまとめて取得し、プレイ中は追加通信なしで進行する。
- **FR-005**: 単語バトルは正解でEXP+4・Combo+1・敵ダメージ=10+Combo×2、不正解でHP-10・Comboリセット、5問後に結果をまとめて表示する。
- **FR-006**: 文法ダンジョンは正解でEXP+3・Defense+0.2、不正解でHP-6、5フロアの結果を記録し表示する。
- **FR-007**: 会話タバーンは5ターンでGeminiが返答を流暢さ・関連性・タスク達成度の簡易ルーブリックで自動評価し、成功/普通/失敗を判定してそれぞれEXP+5/+3/+1、Gold+10/+5/0、HP減少なしでリザルトを出す。
- **FR-008**: スペリングチャレンジは完全一致でEXP+5、1文字ミスでEXP+2/HP-5、不正解でEXP+1/HP-12を適用し、正答とヒントを提示する。
- **FR-009**: リスニングモードは正解でEXP+4、不正解でEXP+2/HP-6を適用し、再生/リプレイ操作を提供する。
- **FR-010**: レベルアップ条件（30/50/80/120EXP）と報酬（MaxHP+10、HP全回復、Attack+2、Defense+1）を適用し、戦闘不能時はEXP-5とHP50%復活を行う。
- **FR-011**: 装備は武器/防具/指輪/お守りスロットを持ち、各モードの報酬・被ダメージに所定の倍率（例: 単語EXP+20%、文法ダメージ-30%、会話EXP+50%、スペルEXP+30%）を反映する。
- **FR-012**: AI弱点分析は直近50〜200問を集計し、弱点/強み/推奨モードをJSON形式で生成し、街のAIアドバイス欄および出題優先度に反映する。
- **FR-013**: 履歴は各セッションの日時、モード、正答数またはターン結果、獲得/消費（EXP/HP/Gold/Defense/Combo/最高コンボ）を保存し、一覧と詳細で閲覧できる。
- **FR-014**: 言語設定でUI言語（ja/en）、解説言語（日本語補足あり/英語のみ）、問題言語（基本en）を切り替え、メニュー/ヘルプ表示が設定に即して更新される。
- **FR-015**: 共通キーバインド（j/k移動、Enter決定、Tabフィールド切替、qまたはEscで戻る/終了）を画面下部に表示し、全モードで一貫して動作する。

### Key Entities *(include if feature involves data)*

- **PlayerProfile**: 名前、クラス、LV、EXP、HP/MaxHP、Attack、Defense、Combo、Streak、Gold、装備スロット、開放モード。
- **SessionRecord**: モード種別、日時、出題セットID、正答数またはターン結果、獲得/消費リソース、最高コンボ、レベルアップ・戦闘不能フラグ。
- **QuestionSet**: 5問の出題内容（敵名/単語/選択肢/解答/解説、またはトラップ名・音声・NPC応答などモード別メタ情報を含む）。
- **EquipmentItem**: スロット種別（武器/防具/指輪/お守り）、名称、効果種別（EXP増加/ダメージ軽減等）、対象モード。
- **WeaknessAnalysis**: weak_points、strength_points、recommendation、分析対象範囲（過去50〜200問）、生成日時。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 学習者が任意モードの5問セッションを開始からリザルト表示まで平均2分以内で完了できる（テスト10回の平均が2分以下）。
- **SC-002**: 95%以上のセッションで開始時に5問分の出題データが揃い、プレイ中に追加通信なしで完走できる。
- **SC-003**: セッション終了直後にステータスバーおよび履歴へ反映されるEXP/HP/Gold/Defense/コンボ値が、定義された計算ルールと100%一致する。
- **SC-004**: 言語設定を切り替えた場合、主要画面（トップ/街/各モード/設定/履歴）のラベルとヘルプ表示が1画面再描画以内に選択言語へ切り替わる割合が100%。
